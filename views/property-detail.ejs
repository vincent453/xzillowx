<!-- views/property-detail.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <style>
    /* Base styles */
    body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  line-height: 1.6;
  color: #333;
  margin: 0;
  padding: 0;
  background-color: #f9f9f9;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

/* Header styles */
header {
  padding: 15px 0;
  border-bottom: 1px solid #eee;
  margin-bottom: 20px;
}

header .logo {
  font-size: 24px;
  font-weight: bold;
}

/* Property detail layout */
.property-detail {
  display: grid;
  grid-template-columns: 1fr;
  gap: 30px;
}

@media (min-width: 768px) {
  .property-detail {
    grid-template-columns: 3fr 2fr;
  }
}

/* Image gallery */
.image-gallery {
  position: relative;
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 20px;
}

.main-image {
  width: 100%;
  height: 400px;
  object-fit: cover;
}

.gallery-nav {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.thumbnail {
  width: 80px;
  height: 60px;
  object-fit: cover;
  border-radius: 4px;
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.2s;
}

.thumbnail:hover, .thumbnail.active {
  opacity: 1;
}

/* Property info */
.property-info {
  background: white;
  padding: 25px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.property-price {
  font-size: 28px;
  font-weight: bold;
  margin-bottom: 10px;
  color: #1a1a1a;
}

.property-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-bottom: 20px;
  font-size: 16px;
}

.property-meta span {
  display: inline-flex;
  align-items: center;
}

.property-address {
  margin-bottom: 20px;
  font-size: 16px;
}

.property-description {
  margin-top: 25px;
  line-height: 1.8;
}

.broker-info {
  margin-top: 30px;
  padding-top: 20px;
  border-top: 1px solid #eee;
  font-size: 14px;
}

/* Contact form */
.contact-form {
  margin-top: 30px;
}

.contact-form h3 {
  margin-bottom: 15px;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 16px;
}

textarea.form-control {
  min-height: 100px;
}

.btn {
  background-color: #2563eb;
  color: white;
  border: none;
  padding: 12px 20px;
  font-size: 16px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.btn:hover {
  background-color: #1d4ed8;
}

/* Back button */
.back-link {
  display: inline-block;
  margin-bottom: 20px;
  color: #2563eb;
  text-decoration: none;
}

.back-link:hover {
  text-decoration: underline;
}

/* Mobile view adjustments */
@media (max-width: 767px) {
  .container {
    padding: 10px;
  }

  header {
    text-align: center;
  }

  header .logo {
    font-size: 20px;
  }

  .property-detail {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .main-image {
    height: 250px;
  }

  .gallery-nav {
    justify-content: center;
    gap: 5px;
  }

  .thumbnail {
    width: 60px;
    height: 45px;
  }

  .property-info {
    padding: 15px;
  }

  .property-price {
    font-size: 24px;
  }

  .property-meta {
    font-size: 14px;
    gap: 10px;
  }

  .property-address {
    font-size: 14px;
  }

  .contact-form h3 {
    font-size: 18px;
  }

  .form-control {
    font-size: 14px;
    padding: 8px;
  }

  .btn {
    font-size: 14px;
    padding: 10px 15px;
  }
}


  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="logo">Real Estate Listings</div>
    </div>
  </header>
  
  <div class="container">
    <a href="/" class="back-link">← Back to Listings</a>
    
    <div class="property-detail">
      <div class="left-column">
        <div class="image-gallery">
          <img src="<%= property.images ? property.images[0] : property.mainImage %>" alt="<%= property.address %>" class="main-image" id="main-image">
          
          <div class="gallery-nav">
            <% 
              const images = property.images || 
                [property.mainImage].concat(property.additionalImages || []);
            %>
            
            <% images.forEach((image, index) => { %>
              <img 
                src="<%= image %>" 
                alt="Property image <%= index + 1 %>" 
                class="thumbnail <%= index === 0 ? 'active' : '' %>"
                onclick="changeMainImage('<%= image %>', this)"
              >
            <% }) %>
          </div>
        </div>
        
        <div class="property-description">
          <h2>Property Description</h2>
          <p><%= property.description || 'Beautiful property in a desirable location. This property offers comfort and convenience with easy access to local amenities.' %></p>
          
          <% if (property.features && property.features.length > 0) { %>
            <h3>Features</h3>
            <ul>
              <% property.features.forEach(feature => { %>
                <li><%= feature %></li>
              <% }) %>
            </ul>
          <% } %>
        </div>
      </div>
      
      <div class="right-column">
        <div class="property-info">
          <div class="property-price">$<%= property.price.toLocaleString() %></div>
          
          <div class="property-meta">
            <span><%= property.bedrooms || property.beds %> beds</span>
            <span><%= property.bathrooms || property.baths %> baths</span>
            <span><%= property.squareFeet || property.sqft %> sqft</span>
            <% if (property.propertyType) { %>
              <span><%= property.propertyType.charAt(0).toUpperCase() + property.propertyType.slice(1) %></span>
            <% } %>
          </div>
          
          <div class="property-address">
            <%= property.address %><br>
            <%= property.city %>, <%= property.state %> <%= property.zipcode %>
          </div>
          
          <% if (property.priceCut) { %>
            <div class="price-history">
              <h3>Price History</h3>
              <p>Price reduced by $<%= property.priceCut.amount.toLocaleString() %> on <%= property.priceCut.date %></p>
            </div>
          <% } %>
          
          <div class="broker-info">
            Listed by: <%= property.broker || property.contactName %>
          </div>
          
          <div class="contact-form">
            <h3>Contact Agent</h3>
            <form id="agent-contact-form" data-listing-id="<%= property._id %>">
              <div class="form-group">
                <label for="name">Your Name</label>
                <input type="text" id="name" class="form-control" required>
              </div>
              
              <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" class="form-control" required>
              </div>
              
              <div class="form-group">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" class="form-control">
              </div>
              
              <div class="form-group">
                <label for="message">Message</label>
                <textarea id="message" class="form-control" required>I'm interested in this property. Please contact me with more information.</textarea>
              </div>
              
              <button type="submit" class="btn">Send Message</button>
              <div id="form-status" class="mt-3"></div>
            </form>
            
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Function to change the main image when clicking thumbnails
    function changeMainImage(src, thumbnail) {
      // Update main image
      document.getElementById('main-image').src = src;
      
      // Update active thumbnail
      document.querySelectorAll('.thumbnail').forEach(thumb => {
        thumb.classList.remove('active');
      });
      thumbnail.classList.add('active');
    }
    
// Contact form handling
document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("agent-contact-form");
  const formStatus = document.getElementById("form-status");

  form.addEventListener("submit", async function (event) {
    event.preventDefault(); // Prevent default form submission

    const listingId = form.getAttribute("data-listing-id"); // Get the property ID
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const message = document.getElementById("message").value.trim();

    // ✅ Validation: Ensure required fields are filled
    if (!name || !email || !message) {
      formStatus.innerHTML = "<p style='color: red;'>Please fill out all required fields.</p>";
      return;
    }

    try {
      const response = await fetch(`/api/properties/contact/${listingId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ name, email, phone, message }),
      });

      const data = await response.json();
      
      if (data.success) {
        formStatus.innerHTML = "<p style='color: green;'>Message sent successfully!</p>";
        form.reset();
      } else {
        formStatus.innerHTML = `<p style='color: red;'>Error: ${data.message}</p>`;
      }
    } catch (error) {
      console.error("Error sending message:", error);
      formStatus.innerHTML = "<p style='color: red;'>Failed to send message. Please try again later.</p>";
    }
  });
});

  </script>
</body>
</html>